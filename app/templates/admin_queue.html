<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Work Queue</title>
    <link rel="stylesheet" href="{{ url_for('static', path='style.css') }}">
</head>
<body>
    <main class="container container--wide">
        <header>
            <h1>Work Queue</h1>
            <p>Review and manage badge print requests awaiting processing.</p>
        </header>

        {% if success %}
            <div class="alert success" role="status">
                {{ success }}
            </div>
        {% endif %}
        {% if error %}
            <div class="alert error" role="alert">
                {{ error }}
            </div>
        {% endif %}

        <section class="queue-section">
            <div class="queue-controls">
                <div>
                    {% if show_processed %}
                        <a class="secondary" href="{{ url_for('admin_work_items') }}">Hide processed items</a>
                    {% else %}
                        <a class="secondary" href="{{ url_for('admin_work_items') }}?show_processed=1">Show processed items</a>
                    {% endif %}
                </div>
                <p class="queue-hint">Showing up to {{ queue_limit }} recent item{{ '' if queue_limit == 1 else 's' }}.</p>
            </div>

            {% if queue_items %}
                <div class="queue-table-wrapper">
                    <table class="queue-table">
                        <thead>
                            <tr>
                                <th scope="col">ID</th>
                                <th scope="col">Details</th>
                                <th scope="col">Preview</th>
                                <th scope="col">Status</th>
                                <th scope="col">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in queue_items %}
                                <tr>
                                    <td data-label="ID">#{{ item.id }}</td>
                                    <td data-label="Details">
                                        <div class="queue-meta">
                                            <strong>{{ item.name }}</strong>
                                            <span class="queue-meta__line">Badge: {{ item.unique_id }}</span>
                                            <span class="queue-meta__line">Image: {{ item.image_label }}</span>
                                            <span class="queue-meta__line">Color: {{ (item.image_color or 'black') | capitalize }}</span>
                                            {% if item.font_size %}
                                                <span class="queue-meta__line">Font Size: {{ item.font_size }}px</span>
                                            {% endif %}
                                            {% if item.text_x is not none and item.text_y is not none %}
                                                <span class="queue-meta__line">Position: ({{ item.text_x }}, {{ item.text_y }})</span>
                                            {% endif %}
                                            <span class="queue-meta__line">Font: {{ item.image_font or 'Awkward.ttf' }}</span>
                                        </div>
                                    </td>
                                    <td data-label="Preview">
                                        <div class="queue-preview">
                                            <img
                                                src="{{ item.image_data_uri }}"
                                                alt="{{ item.image_label }} preview"
                                                data-lightbox-src="{{ item.image_data_uri }}"
                                                data-lightbox-label="{{ item.image_label }}"
                                                data-lightbox-font="{{ item.image_font or 'Awkward.ttf' }}"
                                                data-lightbox-color="{{ item.image_color or 'black' }}"
                                            >
                                        </div>
                                    </td>
                                    <td data-label="Status">
                                        <div class="queue-status">
                                            <span class="status-pill {{ 'status-processed' if item.is_processed else 'status-pending' }}">
                                                {{ 'Processed' if item.is_processed else 'Pending' }}
                                            </span>
                                            <span class="queue-timestamp">
                                                <strong>Created:</strong>
                                                {{ item.created_at or 'â€”' }}
                                            </span>
                                            {% if item.processed_at %}
                                                <span class="queue-timestamp">
                                                    <strong>Processed:</strong>
                                                    {{ item.processed_at }}
                                                </span>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td data-label="Actions">
                                        <div class="queue-actions">
                                            {% if not item.is_processed %}
                                                <form method="post" action="{{ url_for('admin_work_items_mark', work_id=item.id) }}">
                                                    {% if show_processed %}
                                                        <input type="hidden" name="show_processed" value="1">
                                                    {% endif %}
                                                    <button type="submit" class="secondary">Mark processed</button>
                                                </form>
                                            {% endif %}
                                            <form method="post" action="{{ url_for('admin_work_items_delete', work_id=item.id) }}">
                                                {% if show_processed %}
                                                    <input type="hidden" name="show_processed" value="1">
                                                {% endif %}
                                                <button type="submit" class="danger">Delete</button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="empty-state">
                    {% if show_processed %}
                        No work items found.
                    {% else %}
                        No pending work items in the queue.
                    {% endif %}
                </p>
            {% endif %}
        </section>
    </main>
    <div class="lightbox-overlay" id="lightbox-overlay" aria-modal="true" role="dialog" hidden>
        <div class="lightbox-content" role="document">
            <button type="button" class="lightbox-close" id="lightbox-close">Close</button>
            <img id="lightbox-image" alt="Expanded badge preview">
            <div class="lightbox-meta" id="lightbox-meta"></div>
        </div>
    </div>
    <script>
        (function () {
            const overlay = document.getElementById('lightbox-overlay');
            if (!overlay) {
                return;
            }

            const imageElement = document.getElementById('lightbox-image');
            const metaElement = document.getElementById('lightbox-meta');
            const closeButton = document.getElementById('lightbox-close');
            const previewImages = Array.from(document.querySelectorAll('.queue-preview img[data-lightbox-src]'));

            function closeLightbox() {
                overlay.classList.remove('is-visible');
                overlay.hidden = true;
                imageElement.removeAttribute('src');
                imageElement.style.removeProperty('width');
                imageElement.style.removeProperty('height');
                metaElement.textContent = '';
            }

            function openLightbox(preview) {
                const src = preview.dataset.lightboxSrc;
                if (!src) {
                    return;
                }

                imageElement.onload = () => {
                    const SCALE = 4;
                    const maxWidth = window.innerWidth * 0.9;
                    const maxHeight = window.innerHeight * 0.85;
                    let width = imageElement.naturalWidth * SCALE;
                    let height = imageElement.naturalHeight * SCALE;
                    const scaleFactor = Math.min(maxWidth / width, maxHeight / height, 1);
                    width *= scaleFactor;
                    height *= scaleFactor;
                    imageElement.style.width = `${width}px`;
                    imageElement.style.height = `${height}px`;
                };
                imageElement.src = src;
                const label = preview.dataset.lightboxLabel || 'Preview image';
                imageElement.alt = `${label} enlarged`;
                const font = preview.dataset.lightboxFont || 'Default';
                const color = (preview.dataset.lightboxColor || 'black').toUpperCase();
                metaElement.innerHTML = `
                    <div><strong>Image:</strong> ${label}</div>
                    <div><strong>Font:</strong> ${font}</div>
                    <div><strong>Ink:</strong> ${color}</div>
                `;
                overlay.hidden = false;
                requestAnimationFrame(() => overlay.classList.add('is-visible'));
            }

            previewImages.forEach((img) => {
                img.addEventListener('click', () => openLightbox(img));
                img.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter' || event.key === ' ') {
                        event.preventDefault();
                        openLightbox(img);
                    }
                });
                img.tabIndex = 0;
            });

            closeButton.addEventListener('click', closeLightbox);
            overlay.addEventListener('click', (event) => {
                if (event.target === overlay) {
                    closeLightbox();
                }
            });
            window.addEventListener('keydown', (event) => {
                if (event.key === 'Escape' && !overlay.hidden) {
                    closeLightbox();
                }
            });
        })();
    </script>
</body>
</html>
